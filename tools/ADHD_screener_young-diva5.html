<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Young DIVA-5 ADHD Screener</title>
    <style>
        :root {
            --font-family-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --font-family-serif: "Georgia", "Times New Roman", serif;

            /* Light Mode (Default) */
            --primary-color-light: #007bff;
            --secondary-color-light: #6c757d;
            --background-color-light: #f8f9fa;
            --text-color-light: #212529;
            --card-bg-light: #ffffff;
            --card-border-light: #dee2e6;
            --input-bg-light: #fff;
            --input-border-light: #ced4da;
            --button-bg-light: #007bff;
            --button-text-light: #ffffff;
            --button-hover-bg-light: #0056b3;
            --link-color-light: #007bff;
            --progress-bar-bg-light: #e9ecef;
            --progress-bar-fill-light: #007bff;
            --toggle-bg-off-light: #ccc;
            --toggle-bg-on-light: var(--primary-color-light);
            --toggle-knob-light: white;

            /* Dark Mode */
            --primary-color-dark: #0d6efd; /* A slightly brighter blue for dark mode */
            --secondary-color-dark: #adb5bd;
            --background-color-dark: #1a1a1a; /* Darker background */
            --text-color-dark: #e0e0e0; /* Lighter text */
            --card-bg-dark: #2c2c2c; /* Darker card background */
            --card-border-dark: #444444;
            --input-bg-dark: #333;
            --input-border-dark: #555;
            --button-bg-dark: #0d6efd;
            --button-text-dark: #ffffff;
            --button-hover-bg-dark: #0a58ca;
            --link-color-dark: #3b9dff; /* Brighter link for dark mode */
            --progress-bar-bg-dark: #444444;
            --progress-bar-fill-dark: #0d6efd;
            --toggle-bg-off-dark: #555;
            --toggle-bg-on-dark: var(--primary-color-dark);
            --toggle-knob-dark: #ddd;
        }

        body {
            font-family: var(--font-family-sans);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        body.light-mode {
            background-color: var(--background-color-light);
            color: var(--text-color-light);
        }

        body.dark-mode {
            background-color: var(--background-color-dark);
            color: var(--text-color-dark);
        }

        #app-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 8px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        body.light-mode #app-container {
            background-color: var(--card-bg-light);
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border: 1px solid var(--card-border-light);
        }

        body.dark-mode #app-container {
            background-color: var(--card-bg-dark);
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            border: 1px solid var(--card-border-dark);
        }

        .page {
            display: none; /* Hidden by default, shown by JS */
            padding: 20px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1, h2, h3 {
            margin-top: 0;
        }
        body.light-mode h1, body.light-mode h2, body.light-mode h3 { color: var(--primary-color-light); }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3 { color: var(--primary-color-dark); }


        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
            margin-top: 10px;
            margin-right: 10px;
        }
        body.light-mode button {
            background-color: var(--button-bg-light);
            color: var(--button-text-light);
        }
        body.dark-mode button {
            background-color: var(--button-bg-dark);
            color: var(--button-text-dark);
        }
        body.light-mode button:hover { background-color: var(--button-hover-bg-light); }
        body.dark-mode button:hover { background-color: var(--button-hover-bg-dark); }

        button.secondary {
            background-color: var(--secondary-color-light);
        }
        body.dark-mode button.secondary {
            background-color: var(--secondary-color-dark);
        }
        body.light-mode button.secondary:hover { background-color: #5a6268; }
        body.dark-mode button.secondary:hover { background-color: #828a93; }


        .settings-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 200px; 
        }
        body.light-mode .settings-controls { background-color: rgba(255,255,255,0.8); border: 1px solid var(--card-border-light); }
        body.dark-mode .settings-controls { background-color: rgba(44,44,44,0.8); border: 1px solid var(--card-border-dark); }

        .settings-controls .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            width: 100%; 
        }

        .settings-controls .toggle-label-text {
            font-size: 0.9em;
            white-space: nowrap; 
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 44px; 
            height: 24px; 
            flex-shrink: 0; 
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 24px; 
            transition: .4s;
        }
        body.light-mode .slider { background-color: var(--toggle-bg-off-light); }
        body.dark-mode .slider { background-color: var(--toggle-bg-off-dark); }


        .slider:before {
            position: absolute;
            content: "";
            height: 18px; 
            width: 18px;  
            left: 3px;   
            bottom: 3px; 
            border-radius: 50%;
            transition: .4s;
        }
        body.light-mode .slider:before { background-color: var(--toggle-knob-light); }
        body.dark-mode .slider:before { background-color: var(--toggle-knob-dark); }

        
        body.light-mode input:checked + .slider { background-color: var(--toggle-bg-on-light); }
        body.dark-mode input:checked + .slider { background-color: var(--toggle-bg-on-dark); }


        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3; 
        }

        input:checked + .slider:before {
            transform: translateX(20px); 
        }


        #progress-indicator {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        body.light-mode #progress-indicator { background-color: var(--progress-bar-bg-light); }
        body.dark-mode #progress-indicator { background-color: var(--progress-bar-bg-dark); }

        #progress-bar {
            width: 0%;
            height: 100%;
            transition: width 0.3s ease-in-out;
        }
        body.light-mode #progress-bar { background-color: var(--progress-bar-fill-light); }
        body.dark-mode #progress-bar { background-color: var(--progress-bar-fill-dark); }
        #progress-text {
            text-align: center;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        body.light-mode #progress-text { color: var(--secondary-color-light); }
        body.dark-mode #progress-text { color: var(--secondary-color-dark); }


        .question-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .question-text {
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .examples-group {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 5px;
        }
        body.light-mode .examples-group { border: 1px solid var(--input-border-light); background-color: #fdfdfd; }
        body.dark-mode .examples-group { border: 1px solid var(--input-border-dark); background-color: #333; }


        .examples-group h3 {
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 10px;
        }
        body.light-mode .examples-group h3 { color: var(--primary-color-light); }
        body.dark-mode .examples-group h3 { color: var(--primary-color-dark); }

        .example-item {
            display: block;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        body.light-mode .example-item { border: 1px solid var(--input-border-light); background-color: var(--input-bg-light); }
        body.dark-mode .example-item { border: 1px solid var(--input-border-dark); background-color: var(--input-bg-dark); }

        body.light-mode .example-item:hover { background-color: #e9ecef; }
        body.dark-mode .example-item:hover { background-color: #444; }

        .example-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .example-item.selected {
            font-weight: bold;
        }
        body.light-mode .example-item.selected { border-left: 5px solid var(--primary-color-light); background-color: #e0efff; }
        body.dark-mode .example-item.selected { border-left: 5px solid var(--primary-color-dark); background-color: #3a4a60; }


        .radio-group label, .checkbox-group label {
            display: block;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        body.light-mode .radio-group label, body.light-mode .checkbox-group label { border: 1px solid var(--input-border-light); background-color: var(--input-bg-light); }
        body.dark-mode .radio-group label, body.dark-mode .checkbox-group label { border: 1px solid var(--input-border-dark); background-color: var(--input-bg-dark); }

        body.light-mode .radio-group label:hover, body.light-mode .checkbox-group label:hover { background-color: #e9ecef; }
        body.dark-mode .radio-group label:hover, body.dark-mode .checkbox-group label:hover { background-color: #444; }

        .radio-group input[type="radio"], .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
        }

        input[type="number"], input[type="text"] {
            padding: 8px;
            border-radius: 4px;
            margin-top: 5px;
            width: calc(100% - 18px); 
            max-width: 200px;
        }
        body.light-mode input[type="number"], body.light-mode input[type="text"] {
            border: 1px solid var(--input-border-light);
            background-color: var(--input-bg-light);
            color: var(--text-color-light);
        }
        body.dark-mode input[type="number"], body.dark-mode input[type="text"] {
            border: 1px solid var(--input-border-dark);
            background-color: var(--input-bg-dark);
            color: var(--text-color-dark);
        }


        .navigation-controls {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #report-area {
            padding: 20px;
        }
        #report-content {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            max-height: 50vh; 
            overflow-y: auto;
        }
        body.light-mode #report-content { border: 1px solid var(--card-border-light); background-color: #f1f3f5; }
        body.dark-mode #report-content { border: 1px solid var(--card-border-dark); background-color: #222; }

        .report-section { margin-bottom: 15px; white-space: normal; }
        .report-section h3 {
            font-size: 1.2em;
            margin-bottom: 3px; 
            border-bottom: 1px solid;
            padding-bottom: 3px; 
            white-space: normal; 
        }
        body.light-mode .report-section h3 { border-bottom-color: var(--card-border-light); }
        body.dark-mode .report-section h3 { border-bottom-color: var(--card-border-dark); }

        .report-section p { margin: 5px 0; }
        .report-section ul { padding-left: 20px; margin: 5px 0; } 

        .report-section ul.diagnosis-list {
            margin-top: 0px;
            margin-bottom: 0px;
            padding-left: 20px;
            list-style-type: none;
        }
        .report-section ul.diagnosis-list li { margin-bottom: 1px; white-space: normal; }
        .report-section ul.diagnosis-list li.indicated { font-weight: bold; }
        .report-section ul.diagnosis-list li.indicated::before { content: "[X] "; }
        .report-section ul.diagnosis-list li:not(.indicated)::before { content: "[ ] "; }
        
        /* Styles for nested example lists in the report (Young DIVA) */
        .report-section ul.diagnosis-list li ul {
            padding-left: 20px; /* Indent for example list */
            list-style-type: disc; /* Bullets for examples */
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .report-section ul.diagnosis-list li ul li {
            font-weight: normal; 
            margin-bottom: 2px;
        }
        .report-section ul.diagnosis-list li ul li::before {
            content: ""; /* Remove the [X] or [ ] from example items */
        }
        .report-section ul.diagnosis-list li ul li[style*="list-style-type: none"] { 
            list-style-type: none !important;
            margin-left: -20px; 
        }


        /* Print-specific styles */
        @media print {
            body {
                background-color: #fff !important; 
                color: #000 !important; 
                font-family: var(--font-family-serif); 
            }
            #app-container {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                max-width: 100% !important;
            }
            .settings-controls, .navigation-controls, #progress-indicator, #progress-text, #download-pdf-button, #restart-button-report {
                display: none !important;
            }
            #report-area, #report-content {
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
                background-color: #fff !important;
                max-height: none !important;
                overflow-y: visible !important;
                white-space: normal; 
            }
            .page { display: none !important; } 
            #report-area.active { display: block !important; } 

            .example-item.selected {
                border-left: none !important;
                background-color: #fff !important;
                font-weight: normal !important; 
            }
            .report-section h3 {
                color: #000 !important;
                border-bottom-color: #ccc !important;
            }
            .report-section ul.diagnosis-list li.indicated::before { content: "[X] "; color: #000 !important; }
            .report-section ul.diagnosis-list li:not(.indicated)::before { content: "[ ] "; color: #000 !important; }
            .report-section ul.diagnosis-list li ul li::before { content: "â€¢ "; } 
            .report-section ul.diagnosis-list li ul li[style*="list-style-type: none"]::before { content: "" !important; }
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            #app-container {
                margin: 10px;
                padding: 15px;
            }
            .page {
                padding: 10px;
            }
            .settings-controls {
                position: static;
                flex-direction: column;
                align-items: stretch; 
                margin-bottom: 15px;
                padding: 10px;
                min-width: unset; 
            }
            .settings-controls .toggle-group { 
                margin-bottom: 8px; 
                width: 100%; 
            }
            button {
                padding: 12px 15px; 
                font-size: 1.1em;
            }
            .navigation-controls {
                flex-direction: column;
            }
            .navigation-controls button {
                width: 100%;
                margin-bottom: 10px;
            }
            .navigation-controls button:last-child {
                margin-bottom: 0;
            }
        }

    </style>
</head>
<body class="light-mode">

    <div class="settings-controls">
        <div class="toggle-group">
            <span class="toggle-label-text">Dark Mode</span>
            <label class="switch">
                <input type="checkbox" id="theme-toggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="toggle-group" id="simulate-mode-label">
            <span class="toggle-label-text">Simulate Mode</span>
            <label class="switch">
                <input type="checkbox" id="simulate-mode-toggle">
                <span class="slider"></span>
            </label>
        </div>
        <button id="reset-button-global" class="secondary" style="display: none;">Reset Questionnaire</button>
    </div>

    <div id="app-container">
        <div id="progress-indicator">
            <div id="progress-bar"></div>
        </div>
        <div id="progress-text">Step 0 of 0</div>

        <!-- Page: Introduction -->
        <div id="intro-page" class="page">
            <h1>Welcome to the Young DIVA-5 ADHD Screener</h1>
            <p>This tool is designed to help explore symptoms related to Attention-Deficit/Hyperactivity Disorder (ADHD) in children and adolescents (ages 5-17) based on the Young DIVA-5. The Young DIVA-5 is adapted from the DIVA-5 for adults.</p>
            <p>This screener is typically completed by a parent or guardian with input from the young person where appropriate. It is <strong>not a diagnostic tool</strong> and cannot replace a professional consultation with a qualified healthcare provider.</p>
            <p>The screener will ask about symptoms experienced currently or within the last 6 months.</p>
            <p>Please answer thoughtfully and honestly. All information you provide is processed locally in your browser and is not stored or transmitted anywhere.</p>
            <button id="start-disclaimer-button">Next: Disclaimer</button>
        </div>

        <!-- Page: Disclaimer -->
        <div id="disclaimer-page" class="page">
            <h1>Disclaimer & Privacy</h1>
            <p><strong>Not a Diagnostic Tool:</strong> This screener is for informational and educational purposes only. It is not intended to provide a medical diagnosis of ADHD or any other condition. A formal diagnosis can only be made by a qualified healthcare professional through a comprehensive clinical evaluation.</p>
            <p><strong>Privacy:</strong> Your privacy is important. All responses you provide are processed locally within your web browser. No data is sent to any server, stored permanently, or shared with any third parties. When you close this browser tab or window, your session data will be lost unless you download the report.</p>
            <p><strong>Confidentiality of Report:</strong> At the end of the screener, you will have the option to generate and download a report of your responses and an initial assessment summary. It is your responsibility to manage the confidentiality of this downloaded report.</p>
            <p><strong>Accuracy of Information:</strong> While this screener is based on the Young DIVA-5 criteria, the interpretation and application of these criteria in a clinical setting involve professional judgment. The accuracy of the screener's output depends on the accuracy of your reporting.</p>
            <p>By proceeding, you acknowledge that you have read, understood, and agree to this disclaimer.</p>
            <label>
                <input type="checkbox" id="disclaimer-confirm"> I have read and understood the disclaimer.
            </label>
            <br>
            <button id="start-questionnaire-button" disabled>Start Questionnaire</button>
        </div>

        <!-- Page: Questionnaire Area -->
        <div id="questionnaire-area" class="page">
            <div id="question-content">
                <!-- Question text and examples will be rendered here by JS -->
            </div>
            <div class="navigation-controls">
                <button id="prev-question-button" style="display: none;">Previous</button>
                <button id="next-question-button">Next</button>
            </div>
        </div>

        <!-- Page: Report Area -->
        <div id="report-area" class="page">
            <h1>Screener Report (Young DIVA-5)</h1>
            <p>This report summarizes the responses and provides an initial assessment based on the Young DIVA-5 criteria. Remember, this is not a formal diagnosis and a comprehensive clinical evaluation by a qualified healthcare professional is required for an actual diagnosis.</p>
            <div id="report-content">
                <!-- Report content will be rendered here by JS -->
            </div>
            <button id="download-pdf-button">Download Report as PDF</button>
            <button id="restart-button-report" class="secondary">Start New Screener</button>
             <p style="margin-top: 20px; text-align: center;"><em>Discover more widgets at <a href="https://cgee.nz/widgets" target="_blank" rel="noopener noreferrer">Chris Barlow's Widget Workshop!</a></em></p>
        </div>

    </div>

    <script>
        // Embedded JavaScript logic for Young DIVA-5
        const YOUNG_DIVA5_DATA = {
            symptoms: {
                inattention: [
                    {
                        id: "A1",
                        key: "A1a",
                        questionText: "Often fails to give close attention to details or makes careless mistakes in schoolwork, at work, or during other activities.",
                        examples: [
                            { num: 1, text: "Makes careless mistakes in schoolwork." },
                            { num: 2, text: "Work is inaccurate or messy." },
                            { num: 3, text: "Does not read instructions carefully." },
                            { num: 4, text: "Overlooks or misses details." },
                            { num: 5, text: "Needs a lot of time to complete detailed tasks." }
                        ]
                    },
                    {
                        id: "A2",
                        key: "A1b",
                        questionText: "Often has difficulty sustaining attention in tasks or play activities.",
                        examples: [
                            { num: 1, text: "Has difficulty staying focused during lessons, conversations, or lengthy reading." },
                            { num: 2, text: "Mind seems to wander easily." },
                            { num: 3, text: "Is easily distracted by unimportant things." },
                            { num: 4, text: "Finds it hard to watch a film all the way through or read a book." },
                            { num: 5, text: "Quickly becomes bored with things unless they are very enjoyable (e.g., computer games)." }
                        ]
                    },
                    {
                        id: "A3",
                        key: "A1c",
                        questionText: "Often does not seem to listen when spoken to directly.",
                        examples: [
                            { num: 1, text: "Mind seems elsewhere, even when there's no obvious distraction." },
                            { num: 2, text: "Is accused of not listening." },
                            { num: 3, text: "Has to be told things several times." },
                            { num: 4, text: "Has difficulty remembering what was just said." }
                        ]
                    },
                    {
                        id: "A4",
                        key: "A1d",
                        questionText: "Often does not follow through on instructions and fails to finish schoolwork, chores, or duties in the workplace (if applicable).",
                        examples: [
                            { num: 1, text: "Starts tasks but quickly loses focus and is easily sidetracked." },
                            { num: 2, text: "Has difficulty completing tasks or homework." },
                            { num: 3, text: "Has difficulty following instructions." },
                            { num: 4, text: "Leaves projects unfinished." }
                        ]
                    },
                    {
                        id: "A5",
                        key: "A1e",
                        questionText: "Often has difficulty organizing tasks and activities.",
                        examples: [
                            { num: 1, text: "Has difficulty managing tasks that need to be done in order." },
                            { num: 2, text: "Keeps materials and belongings messy or disorganized (e.g., messy desk, backpack, room)." },
                            { num: 3, text: "Has poor time management; often late." },
                            { num: 4, text: "Has difficulty planning ahead." },
                            { num: 5, text: "Works in a disorganized way." }
                        ]
                    },
                    {
                        id: "A6",
                        key: "A1f",
                        questionText: "Often avoids, dislikes, or is reluctant to engage in tasks that require sustained mental effort (such as schoolwork or homework).",
                        examples: [
                            { num: 1, text: "Avoids or dislikes homework or schoolwork that requires a lot of thinking." },
                            { num: 2, text: "Puts off tasks that require sustained mental effort." },
                            { num: 3, text: "Prefers tasks that are less mentally demanding." },
                            { num: 4, text: "Complains about tasks being boring or too hard." }
                        ]
                    },
                    {
                        id: "A7",
                        key: "A1g",
                        questionText: "Often loses things necessary for tasks or activities (e.g., school materials, pencils, books, tools, toys, eyeglasses, mobile phones).",
                        examples: [
                            { num: 1, text: "Loses school materials, pencils, books, toys." },
                            { num: 2, text: "Forgets belongings at school or friends' houses." },
                            { num: 3, text: "Loses clothing items." },
                            { num: 4, text: "Spends time looking for misplaced items." }
                        ]
                    },
                    {
                        id: "A8",
                        key: "A1h",
                        questionText: "Is often easily distracted by extraneous stimuli (for older adolescents and adults, may include unrelated thoughts).",
                        examples: [
                            { num: 1, text: "Is easily distracted by sights or sounds." },
                            { num: 2, text: "Has difficulty filtering out irrelevant things." },
                            { num: 3, text: "Attention is easily drawn to unimportant things." },
                            { num: 4, text: "Has difficulty concentrating in noisy environments or during quiet activities if other things are happening." }
                        ]
                    },
                    {
                        id: "A9",
                        key: "A1i",
                        questionText: "Is often forgetful in daily activities.",
                        examples: [
                            { num: 1, text: "Forgets to do chores or run errands." },
                            { num: 2, text: "Forgets appointments or instructions." },
                            { num: 3, text: "Needs reminders for daily tasks." },
                            { num: 4, text: "Forgets to bring things home from school or take things to school." }
                        ]
                    }
                ],
                hyperactivity_impulsivity: [
                     {
                        id: "B1",
                        key: "A2a",
                        questionText: "Often fidgets with or taps hands or feet, or squirms in seat.",
                        examples: [
                            { num: 1, text: "Fidgets with hands or feet." },
                            { num: 2, text: "Taps fingers or feet." },
                            { num: 3, text: "Squirms in seat." },
                            { num: 4, text: "Plays with small objects when supposed to be still." }
                        ]
                    },
                    {
                        id: "B2",
                        key: "A2b",
                        questionText: "Often leaves seat in situations when remaining seated is expected.",
                        examples: [
                            { num: 1, text: "Leaves seat in the classroom or other situations where remaining seated is expected (e.g., during meals)." },
                            { num: 2, text: "Feels restless when required to sit for extended periods." },
                            { num: 3, text: "Finds excuses to get up and move around." }
                        ]
                    },
                    {
                        id: "B3",
                        key: "A2c",
                        questionText: "Often runs about or climbs in situations where it is inappropriate. (Note: In adolescents or adults, may be limited to feeling restless).",
                        examples: [
                            { num: 1, text: "Runs about or climbs excessively in inappropriate situations." },
                            { num: 2, text: "Is always on the go, as if 'driven by a motor'." },
                            { num: 3, text: "Has difficulty playing or engaging in activities quietly." },
                            { num: 4, text: "(For older children/adolescents) Feels very restless." }
                        ]
                    },
                    {
                        id: "B4",
                        key: "A2d",
                        questionText: "Often unable to play or engage in leisure activities quietly.",
                        examples: [
                            { num: 1, text: "Has difficulty playing or engaging in leisure activities quietly." },
                            { num: 2, text: "Makes excessive noise during play." },
                            { num: 3, text: "Disturbs others with noisy activities." }
                        ]
                    },
                    {
                        id: "B5",
                        key: "A2e",
                        questionText: "Is often 'on the go,' acting as if 'driven by a motor'.",
                        examples: [
                            { num: 1, text: "Is always busy and active." },
                            { num: 2, text: "Has difficulty sitting still for extended periods (e.g., in restaurants, during travel)." },
                            { num: 3, text: "Others may comment on being restless or hard to keep up with." }
                        ]
                    },
                    {
                        id: "B6",
                        key: "A2f",
                        questionText: "Often talks excessively.",
                        examples: [
                            { num: 1, text: "Talks a lot, even when it's not their turn." },
                            { num: 2, text: "Dominates conversations." },
                            { num: 3, text: "Has difficulty letting others speak." },
                            { num: 4, text: "Talks even when it's inappropriate (e.g., during quiet time)." }
                        ]
                    },
                    {
                        id: "B7",
                        key: "A2g",
                        questionText: "Often blurts out an answer before a question has been completed.",
                        examples: [
                            { num: 1, text: "Blurts out answers before questions are completed." },
                            { num: 2, text: "Completes people's sentences." },
                            { num: 3, text: "Has difficulty waiting for their turn in conversation or in class." }
                        ]
                    },
                    {
                        id: "B8",
                        key: "A2h",
                        questionText: "Often has difficulty waiting their turn.",
                        examples: [
                            { num: 1, text: "Has difficulty waiting in line or for their turn in games or activities." },
                            { num: 2, text: "Is impatient." },
                            { num: 3, text: "May cut in line or take over others' turns." }
                        ]
                    },
                    {
                        id: "B9",
                        key: "A2i",
                        questionText: "Often interrupts or intrudes on others (e.g., butts into conversations, games, or activities; may start using other people's things without asking or receiving permission).",
                        examples: [
                            { num: 1, text: "Interrupts conversations or activities." },
                            { num: 2, text: "Intrudes on others' games or play." },
                            { num: 3, text: "May start using other people's things without asking." },
                            { num: 4, text: "Takes over what others are doing." }
                        ]
                    }
                ]
            },
            criteria: {
                onset: "Several inattentive or hyperactive-impulsive symptoms were present prior to age 12 years.",
                crossContextualImpairment: "Several inattentive or hyperactive-impulsive symptoms are present in two or more settings (e.g., at home, school, or with friends/relatives; in other activities).",
                significantImpairment: "There is clear evidence that the symptoms interfere with, or reduce the quality of, social, school, or occupational functioning (if applicable).",
                exclusionaryCriteria: "The symptoms do not occur exclusively during the course of a schizophrenic or other psychotic disorder and are not better explained by another mental disorder (e.g., mood disorder, anxiety disorder, dissociative disorder, personality disorder, substance intoxication or withdrawal)."
            },
            diagnosisSummary: {
                inattentionThreshold: 6,
                hyperactivityImpulsivityThreshold: 6,
                combinedPresentationText: "Combined Presentation: If criteria for both inattention and hyperactivity-impulsivity are met.",
                predominantlyInattentivePresentationText: "Predominantly Inattentive Presentation: If criteria for inattention are met but criteria for hyperactivity-impulsivity are not met.",
                predominantlyHyperactiveImpulsivePresentationText: "Predominantly Hyperactive/Impulsive Presentation: If criteria for hyperactivity-impulsivity are met but criteria for inattention are not met."
            }
        };

        const appState = {
            currentPage: 'intro-page', 
            currentQuestionIndex: 0,
            totalQuestions: 0,
            responses: {}, 
            criteriaResponses: {}, 
            simulateMode: false,
            theme: 'light-mode' 
        };

        // DOM Elements
        const pages = {};
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const themeToggle = document.getElementById('theme-toggle');
        const simulateModeToggle = document.getElementById('simulate-mode-toggle');
        const simulateModeLabel = document.getElementById('simulate-mode-label');
        const resetButtonGlobal = document.getElementById('reset-button-global');

        function getSelectedExampleTexts(selectedNumbers, allExamplesList) {
            if (!allExamplesList || !Array.isArray(allExamplesList) || !selectedNumbers || selectedNumbers.length === 0) {
                return [];
            }
            // Sort the selected numbers numerically before mapping
            const sortedSelectedNumbers = [...selectedNumbers].sort((a, b) => a - b);

            return sortedSelectedNumbers.map(num => {
                const example = allExamplesList.find(ex => ex.num === num);
                return example ? `${example.num} - ${example.text}` : `(Example #${num} not found)`;
            }).filter(text => text);
        }


        function initializeScreener() {
            pages['intro-page'] = document.getElementById('intro-page');
            pages['disclaimer-page'] = document.getElementById('disclaimer-page');
            pages['questionnaire-area'] = document.getElementById('questionnaire-area');
            pages['report-area'] = document.getElementById('report-area');

            document.getElementById('start-disclaimer-button').addEventListener('click', () => navigateToPage('disclaimer-page'));
            
            const disclaimerConfirmCheckbox = document.getElementById('disclaimer-confirm');
            const startQuestionnaireButton = document.getElementById('start-questionnaire-button');

            disclaimerConfirmCheckbox.addEventListener('change', () => {
                startQuestionnaireButton.disabled = !disclaimerConfirmCheckbox.checked;
            });

            startQuestionnaireButton.addEventListener('click', () => {
                if (disclaimerConfirmCheckbox.checked) {
                    resetQuestionnaireState(); 
                    appState.totalQuestions = YOUNG_DIVA5_DATA.symptoms.inattention.length + YOUNG_DIVA5_DATA.symptoms.hyperactivity_impulsivity.length + Object.keys(YOUNG_DIVA5_DATA.criteria).length;
                    
                    if (appState.simulateMode) {
                        runFullSimulationAndShowReport();
                    } else {
                        navigateToPage('questionnaire-area');
                        renderQuestion();
                    }
                }
            });

            document.getElementById('prev-question-button').addEventListener('click', navigateQuestionnaire);
            document.getElementById('next-question-button').addEventListener('click', navigateQuestionnaire);
            document.getElementById('download-pdf-button').addEventListener('click', downloadReportAsPDF);
            document.getElementById('restart-button-report').addEventListener('click', () => navigateToPage('intro-page'));
            
            resetButtonGlobal.addEventListener('click', () => {
                if (confirm("Are you sure you want to reset the entire questionnaire? All progress will be lost.")) {
                    resetQuestionnaireState();
                    navigateToPage('intro-page'); 
                }
            });

            themeToggle.addEventListener('change', toggleTheme);
            simulateModeToggle.addEventListener('change', toggleSimulateMode);

            const savedTheme = localStorage.getItem('young_diva5_theme');
            if (savedTheme) {
                appState.theme = savedTheme;
                document.body.className = appState.theme;
                themeToggle.checked = (appState.theme === 'dark-mode');
            }
            const savedSimulateMode = localStorage.getItem('young_diva5_simulate_mode');
            if (savedSimulateMode) {
                appState.simulateMode = savedSimulateMode === 'true';
                simulateModeToggle.checked = appState.simulateMode;
            }
            
            updateProgressBar();
            navigateToPage(appState.currentPage); 
        }

        function toggleTheme() {
            appState.theme = themeToggle.checked ? 'dark-mode' : 'light-mode';
            document.body.className = appState.theme;
            localStorage.setItem('young_diva5_theme', appState.theme);
        }

        function toggleSimulateMode() {
            appState.simulateMode = simulateModeToggle.checked;
            localStorage.setItem('young_diva5_simulate_mode', appState.simulateMode);
        }
        
        function runFullSimulationAndShowReport() {
            function getRandomSubarray(arr, maxSize) {
                const shuffled = [...arr].sort(() => 0.5 - Math.random());
                const size = Math.floor(Math.random() * (Math.min(maxSize, shuffled.length) + 1)); 
                return shuffled.slice(0, size).map(ex => ex.num);
            }

            const allSymptomGroups = [YOUNG_DIVA5_DATA.symptoms.inattention, YOUNG_DIVA5_DATA.symptoms.hyperactivity_impulsivity];

            allSymptomGroups.forEach(symptomGroup => {
                symptomGroup.forEach(symptom => {
                    if (!appState.responses[symptom.id]) {
                        appState.responses[symptom.id] = { count: 0, examples: [] };
                    }

                    if (symptom.examples && symptom.examples.length > 0) {
                        if (Math.random() < 0.7) { 
                            const selectedExamples = getRandomSubarray(symptom.examples, 3); 
                            appState.responses[symptom.id].examples = selectedExamples;
                            appState.responses[symptom.id].count = selectedExamples.length;
                        } else {
                            appState.responses[symptom.id].examples = [];
                            appState.responses[symptom.id].count = 0;
                        }
                    } else {
                        appState.responses[symptom.id].examples = [];
                        appState.responses[symptom.id].count = 0;
                    }
                });
            });
            
            Object.keys(YOUNG_DIVA5_DATA.criteria).forEach(criteriaKey => {
                if (criteriaKey === 'exclusionaryCriteria') {
                    appState.criteriaResponses[criteriaKey] = !(Math.random() < 0.6); 
                } else {
                    appState.criteriaResponses[criteriaKey] = Math.random() < 0.6; 
                }
            });

            appState.currentQuestionIndex = appState.totalQuestions; 
            navigateToPage('report-area');
        }

        function resetQuestionnaireState() {
            appState.currentQuestionIndex = 0;
            appState.responses = {};
            appState.criteriaResponses = {};
            updateProgressBar();
            document.getElementById('disclaimer-confirm').checked = false;
            document.getElementById('start-questionnaire-button').disabled = true;
            resetButtonGlobal.style.display = 'none';
        }


        function navigateToPage(pageId) {
            appState.currentPage = pageId;
            for (const id in pages) {
                pages[id].classList.remove('active');
            }
            if (pages[pageId]) {
                pages[pageId].classList.add('active');
            }

            if (pageId === 'report-area') {
                renderReport(); 
                resetButtonGlobal.style.display = 'inline-block';
            } else if (pageId === 'questionnaire-area') {
                 resetButtonGlobal.style.display = 'inline-block';
            } else {
                resetButtonGlobal.style.display = 'none';
            }
            window.scrollTo(0, 0); 
        }


        function renderQuestion() {
            const questionContent = document.getElementById('question-content');
            questionContent.innerHTML = ''; 

            const allSymptoms = [...YOUNG_DIVA5_DATA.symptoms.inattention, ...YOUNG_DIVA5_DATA.symptoms.hyperactivity_impulsivity];
            const criteriaKeys = Object.keys(YOUNG_DIVA5_DATA.criteria);

            let currentItem;
            let itemType; 

            if (appState.currentQuestionIndex < allSymptoms.length) {
                currentItem = allSymptoms[appState.currentQuestionIndex];
                itemType = 'symptom';
            } else if (appState.currentQuestionIndex < allSymptoms.length + criteriaKeys.length) {
                const criteriaIndex = appState.currentQuestionIndex - allSymptoms.length;
                const criteriaKey = criteriaKeys[criteriaIndex];
                currentItem = { id: criteriaKey, questionText: YOUNG_DIVA5_DATA.criteria[criteriaKey] };
                itemType = 'criteria';
            } else {
                navigateToPage('report-area');
                return;
            }

            const title = document.createElement('h2');
            title.className = 'question-title';
            if (itemType === 'symptom') {
                title.textContent = `Symptom ${appState.currentQuestionIndex + 1} of ${allSymptoms.length}: ${currentItem.id}`;
            } else {
                 const criteriaDisplayIndex = appState.currentQuestionIndex - allSymptoms.length + 1;
                title.textContent = `Criterion Question ${criteriaDisplayIndex} of ${criteriaKeys.length}`;
            }
            questionContent.appendChild(title);

            const questionTextP = document.createElement('p');
            questionTextP.className = 'question-text';
            questionTextP.textContent = currentItem.questionText;
            questionContent.appendChild(questionTextP);

            if (itemType === 'symptom') {
                questionContent.appendChild(createExampleGroup(currentItem, 'Examples (Current or last 6 months)'));
            } else { 
                const radioGroup = document.createElement('div');
                radioGroup.className = 'radio-group';
                const criteriaKey = currentItem.id;

                ['Yes', 'No'].forEach(option => {
                    const label = document.createElement('label');
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = criteriaKey;
                    radio.value = option.toLowerCase();
                    radio.checked = appState.criteriaResponses[criteriaKey] === (option.toLowerCase() === 'yes');
                    
                    radio.addEventListener('change', (e) => {
                        appState.criteriaResponses[criteriaKey] = e.target.value === 'yes';
                    });
                    label.appendChild(radio);
                    label.appendChild(document.createTextNode(option));
                    radioGroup.appendChild(label);
                });
                questionContent.appendChild(radioGroup);
            }

            updateNavigationButtons();
            updateProgressBar();
        }

        function createExampleGroup(symptom, titleText) { 
            const groupDiv = document.createElement('div');
            groupDiv.className = 'examples-group';

            const title = document.createElement('h3');
            title.textContent = titleText;
            groupDiv.appendChild(title);

            const examples = symptom.examples;
            if (!appState.responses[symptom.id]) {
                appState.responses[symptom.id] = { count: 0, examples: [] };
            }
            const currentResponseGroup = appState.responses[symptom.id];

            examples.forEach(example => {
                const label = document.createElement('label');
                label.className = 'example-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = example.num;
                checkbox.checked = currentResponseGroup.examples.includes(example.num);

                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        if (!currentResponseGroup.examples.includes(example.num)) {
                            currentResponseGroup.examples.push(example.num);
                        }
                        label.classList.add('selected');
                    } else {
                        currentResponseGroup.examples = currentResponseGroup.examples.filter(exNum => exNum !== example.num);
                        label.classList.remove('selected');
                    }
                    currentResponseGroup.count = currentResponseGroup.examples.length;
                });

                if (checkbox.checked) label.classList.add('selected');

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(example.text));
                groupDiv.appendChild(label);
            });
            return groupDiv;
        }


        function navigateQuestionnaire(event) {
            const direction = event.target.id === 'next-question-button' ? 1 : -1;
            const allSymptomsLength = YOUNG_DIVA5_DATA.symptoms.inattention.length + YOUNG_DIVA5_DATA.symptoms.hyperactivity_impulsivity.length;

            if (appState.currentQuestionIndex >= allSymptomsLength && appState.currentQuestionIndex < appState.totalQuestions) {
                const criteriaIndex = appState.currentQuestionIndex - allSymptomsLength;
                const criteriaKey = Object.keys(YOUNG_DIVA5_DATA.criteria)[criteriaIndex];
                const radioButtons = document.querySelectorAll(`input[name="${criteriaKey}"]`);
                radioButtons.forEach(radio => {
                    if (radio.checked) {
                        appState.criteriaResponses[criteriaKey] = radio.value === 'yes';
                    }
                });
            }

            appState.currentQuestionIndex += direction;

            if (appState.currentQuestionIndex < 0) {
                appState.currentQuestionIndex = 0; 
            } else if (appState.currentQuestionIndex >= appState.totalQuestions) {
                navigateToPage('report-area');
            } else {
                renderQuestion();
            }
        }

        function updateNavigationButtons() {
            const prevButton = document.getElementById('prev-question-button');
            const nextButton = document.getElementById('next-question-button');

            prevButton.style.display = appState.currentQuestionIndex > 0 ? 'inline-block' : 'none';
            nextButton.textContent = (appState.currentQuestionIndex === appState.totalQuestions - 1) ? 'View Report' : 'Next';
        }

        function updateProgressBar() {
            const progress = appState.totalQuestions > 0 ? (appState.currentQuestionIndex / appState.totalQuestions) * 100 : 0;
            progressBar.style.width = `${progress}%`;
            
            if (appState.currentPage === 'report-area') {
                progressText.textContent = `Report Generated (Completed ${appState.totalQuestions} steps)`;
                progressBar.style.width = `100%`; 
            } else {
                progressText.textContent = `Step ${appState.currentQuestionIndex} of ${appState.totalQuestions}`;
            }
        }

        function calculateScores() {
            const scores = {
                inattention: 0,
                hyperactivity_impulsivity: 0
            };
            const symptomThreshold = 1; 

            YOUNG_DIVA5_DATA.symptoms.inattention.forEach(symptom => {
                if (appState.responses[symptom.id] && appState.responses[symptom.id].count >= symptomThreshold) {
                    scores.inattention++;
                }
            });
            YOUNG_DIVA5_DATA.symptoms.hyperactivity_impulsivity.forEach(symptom => {
                if (appState.responses[symptom.id] && appState.responses[symptom.id].count >= symptomThreshold) {
                    scores.hyperactivity_impulsivity++;
                }
            });
            return scores;
        }

        function generateDiagnosisText(scores) {
            let diagnosisText = "";
            const summary = YOUNG_DIVA5_DATA.diagnosisSummary;

            const meetsInattention = scores.inattention >= summary.inattentionThreshold;
            const meetsHyperactivity = scores.hyperactivity_impulsivity >= summary.hyperactivityImpulsivityThreshold;

            diagnosisText += `<strong>Symptom Criteria (Current or Past 6 Months):</strong>\n`;
            diagnosisText += `  - Inattention Symptoms: ${scores.inattention} (Threshold: ${summary.inattentionThreshold}) - ${meetsInattention ? "Met" : "Not Met"}\n`;
            diagnosisText += `  - Hyperactivity/Impulsivity Symptoms: ${scores.hyperactivity_impulsivity} (Threshold: ${summary.hyperactivityImpulsivityThreshold}) - ${meetsHyperactivity ? "Met" : "Not Met"}\n\n`;
            
            let presentation = "No specific presentation indicated based on symptoms.";
            if (meetsInattention && meetsHyperactivity) {
                presentation = summary.combinedPresentationText;
            } else if (meetsInattention) {
                presentation = summary.predominantlyInattentivePresentationText;
            } else if (meetsHyperactivity) {
                presentation = summary.predominantlyHyperactiveImpulsivePresentationText;
            }
            diagnosisText += `<strong>Potential Presentation:</strong> ${presentation}\n\n`;

            diagnosisText += "<strong>Additional DSM-5 Criteria Assessment:</strong>\n";
            let allCriteriaMet = true;

            const onsetMet = appState.criteriaResponses['onset'] === true;
            diagnosisText += `  - Onset (Several symptoms prior to age 12): ${onsetMet ? "Met" : "Not Met"}\n`;
            if (!onsetMet) allCriteriaMet = false;
            
            const crossContextualMet = appState.criteriaResponses['crossContextualImpairment'] === true;
            diagnosisText += `  - Cross-Contextual Impairment (Symptoms in 2+ settings): ${crossContextualMet ? "Met" : "Not Met"}\n`;
            if (!crossContextualMet) allCriteriaMet = false;

            const significantImpairmentMet = appState.criteriaResponses['significantImpairment'] === true;
            diagnosisText += `  - Significant Impairment (Interference with functioning): ${significantImpairmentMet ? "Met" : "Not Met"}\n`;
            if (!significantImpairmentMet) allCriteriaMet = false;

            const exclusionaryMet = appState.criteriaResponses['exclusionaryCriteria'] === false; 
            diagnosisText += `  - Exclusionary Criteria (Not better explained by another disorder): ${exclusionaryMet ? "Met" : "Not Met"}\n\n`;
            if (!exclusionaryMet) allCriteriaMet = false;

            if (allCriteriaMet && (meetsInattention || meetsHyperactivity)) {
                diagnosisText += "<strong>Overall Indication:</strong> Based on the responses, there are indications that ADHD criteria MAY be met for the young person. This requires confirmation by a qualified healthcare professional.\n";
            } else {
                diagnosisText += "<strong>Overall Indication:</strong> Based on the responses, ADHD criteria do not appear to be fully met for the young person. However, if there are concerns, please consult a qualified healthcare professional.\n";
            }
            return diagnosisText;
        }


        function renderReport() {
            const reportContent = document.getElementById('report-content');
            reportContent.innerHTML = ''; 

            const scores = calculateScores();
            const diagnosisText = generateDiagnosisText(scores);

            const introSection = document.createElement('div');
            introSection.className = 'report-section';
            const introHeader = document.createElement('h3');
            introHeader.textContent = 'Screener Overview (Young DIVA-5)';
            introSection.appendChild(introHeader);
            const introP = document.createElement('p');
            introP.innerHTML = `This report is based on responses related to ADHD symptoms in a young person (ages 5-17), using the Young DIVA-5 framework. Date of report: ${new Date().toLocaleDateString()}`;
            introSection.appendChild(introP);
            reportContent.appendChild(introSection);


            const symptomsSection = document.createElement('div');
            symptomsSection.className = 'report-section';
            const symptomsHeader = document.createElement('h3');
            symptomsHeader.textContent = 'Symptom Checklist Summary';
            symptomsSection.appendChild(symptomsHeader);

            const symptomCategories = [
                { title: 'Part 1: Symptoms of Inattention', symptoms: YOUNG_DIVA5_DATA.symptoms.inattention, score: scores.inattention, threshold: YOUNG_DIVA5_DATA.diagnosisSummary.inattentionThreshold },
                { title: 'Part 2: Symptoms of Hyperactivity/Impulsivity', symptoms: YOUNG_DIVA5_DATA.symptoms.hyperactivity_impulsivity, score: scores.hyperactivity_impulsivity, threshold: YOUNG_DIVA5_DATA.diagnosisSummary.hyperactivityImpulsivityThreshold }
            ];

            symptomCategories.forEach(category => {
                const categoryTitle = document.createElement('h4');
                categoryTitle.textContent = category.title;
                symptomsSection.appendChild(categoryTitle);
                
                const scoreP = document.createElement('p');
                scoreP.innerHTML = `<strong>Symptoms Reported:</strong> ${category.score} (Threshold for indication: ${category.threshold}).`;
                symptomsSection.appendChild(scoreP);

                const ul = document.createElement('ul');
                ul.className = 'diagnosis-list'; 
                category.symptoms.forEach(symptom => {
                    const reported = appState.responses[symptom.id] && appState.responses[symptom.id].count > 0;
                    
                    const li = document.createElement('li');
                    // Get only the main question text before examples are appended
                    li.textContent = `${symptom.id} (${symptom.key}): ${symptom.questionText.substring(0, symptom.questionText.indexOf('.') + 1)} - Reported: ${reported ? 'Yes' : 'No'}`;
                    if (reported) { 
                        li.classList.add('indicated');
                    }
                    ul.appendChild(li);

                    // Display selected examples text
                    const selectedExampleNumbers = appState.responses[symptom.id]?.examples || [];

                    if (selectedExampleNumbers.length > 0) {
                        const examplesContainerUl = document.createElement('ul');
                        // CSS will handle styling these now
                        // examplesContainerUl.style.paddingLeft = '20px'; 
                        // examplesContainerUl.style.listStyleType = 'disc'; 

                        const examplesTitleLi = document.createElement('li');
                        examplesTitleLi.innerHTML = `<em>Examples reported:</em>`;
                        examplesTitleLi.style.listStyleType = 'none'; 
                        examplesContainerUl.appendChild(examplesTitleLi);

                        const exampleTexts = getSelectedExampleTexts(selectedExampleNumbers, symptom.examples);
                        exampleTexts.forEach(text => {
                            const exampleLi = document.createElement('li');
                            exampleLi.textContent = text;
                            examplesContainerUl.appendChild(exampleLi);
                        });
                        
                        if (examplesContainerUl.hasChildNodes()) {
                           li.appendChild(examplesContainerUl);
                        }
                    }
                });
                symptomsSection.appendChild(ul);
            });
            reportContent.appendChild(symptomsSection);

            const criteriaSection = document.createElement('div');
            criteriaSection.className = 'report-section';
            const criteriaHeader = document.createElement('h3');
            criteriaHeader.textContent = 'DSM-5 Diagnostic Criteria Checklist';
            criteriaSection.appendChild(criteriaHeader);
            const criteriaUl = document.createElement('ul');
            criteriaUl.className = 'diagnosis-list';

            const criteriaTextMap = {
                onset: "Several inattentive or hyperactive-impulsive symptoms were present prior to age 12 years.",
                crossContextualImpairment: "Several inattentive or hyperactive-impulsive symptoms are present in two or more settings.",
                significantImpairment: "There is clear evidence that the symptoms interfere with, or reduce the quality of, social, school, or occupational functioning.",
                exclusionaryCriteria: "The symptoms are NOT better explained by another mental disorder." 
            };
            
            const criterionAMet = (scores.inattention >= YOUNG_DIVA5_DATA.diagnosisSummary.inattentionThreshold) || (scores.hyperactivity_impulsivity >= YOUNG_DIVA5_DATA.diagnosisSummary.hyperactivityImpulsivityThreshold);
            const criterionALi = document.createElement('li');
            criterionALi.textContent = `Criterion A (Symptom Count): At least ${YOUNG_DIVA5_DATA.diagnosisSummary.inattentionThreshold} inattention OR ${YOUNG_DIVA5_DATA.diagnosisSummary.hyperactivityImpulsivityThreshold} hyperactivity/impulsivity symptoms. - Result: ${criterionAMet ? "Met" : "Not Met"}`;
            if (criterionAMet) criterionALi.classList.add('indicated');
            criteriaUl.appendChild(criterionALi);


            Object.keys(YOUNG_DIVA5_DATA.criteria).forEach(key => {
                const li = document.createElement('li');
                let met = appState.criteriaResponses[key];
                if (key === 'exclusionaryCriteria') {
                    met = appState.criteriaResponses[key] === false; 
                }
                
                li.textContent = `${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}: ${criteriaTextMap[key]} - Result: ${met ? "Met" : "Not Met"}`;
                if (met) li.classList.add('indicated');
                criteriaUl.appendChild(li);
            });
            criteriaSection.appendChild(criteriaUl);
            reportContent.appendChild(criteriaSection);

            const summarySection = document.createElement('div');
            summarySection.className = 'report-section';
            const summaryHeader = document.createElement('h3');
            summaryHeader.textContent = 'Overall Screener Indication';
            summarySection.appendChild(summaryHeader);
            
            const summaryP = document.createElement('p');
            summaryP.innerHTML = diagnosisText.split('\n').filter(line => line.startsWith("<strong>Overall Indication:") || line.startsWith("<strong>Potential Presentation:")).join('<br>');
            summarySection.appendChild(summaryP);

            const finalDisclaimerP = document.createElement('p');
            finalDisclaimerP.innerHTML = "<strong>Important:</strong> This screener is not a substitute for a professional diagnosis. If there are concerns about ADHD in the young person, please consult with a qualified healthcare provider for a comprehensive evaluation.";
            summarySection.appendChild(finalDisclaimerP);
            reportContent.appendChild(summarySection);

            updateProgressBar(); 
        }


        async function downloadReportAsPDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert("Error: jsPDF library not loaded. Cannot download PDF.");
                if (!document.getElementById('jspdf-script-young')) {
                    const script = document.createElement('script');
                    script.id = 'jspdf-script-young';
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.onload = () => {
                        console.log("jsPDF loaded dynamically for Young DIVA.");
                    };
                    document.head.appendChild(script);
                }
                return;
            }

            const reportContentElement = document.getElementById('report-content');
            const originalBodyClass = document.body.className;
            const originalReportStyle = reportContentElement.style.cssText;

            reportContentElement.style.maxHeight = 'none';
            reportContentElement.style.overflowY = 'visible';
            
            const pdf = new jsPDF({
                orientation: 'p',
                unit: 'pt',
                format: 'a4'
            });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfMargin = 20; 
            const contentWidth = pdfWidth - (pdfMargin * 2);

            pdf.setFontSize(18);
            pdf.text("Young DIVA-5 ADHD Screener Report", pdfMargin, pdfMargin + 10);
            pdf.setFontSize(10);
            pdf.text(`Generated on: ${new Date().toLocaleDateString()}`, pdfMargin, pdfMargin + 25);

            let currentY = pdfMargin + 40; 

            const sections = reportContentElement.querySelectorAll('.report-section');
            for (const section of sections) {
                // Iterate over direct children of the current section to maintain HTML order
                Array.from(section.children).forEach(childElement => {
                    if (childElement.tagName === 'H3') {
                        pdf.setFontSize(14);
                        pdf.setFont(undefined, 'bold');
                        currentY = addWrappedText(pdf, childElement.innerText, pdfMargin, currentY + 15, contentWidth, 14);
                        pdf.setFont(undefined, 'normal');
                    } else if (childElement.tagName === 'H4') {
                        pdf.setFontSize(12); // H4 for category titles like "Part 1:..."
                        pdf.setFont(undefined, 'bold');
                        currentY = addWrappedText(pdf, childElement.innerText, pdfMargin, currentY + 10, contentWidth, 12);
                        pdf.setFont(undefined, 'normal');
                    } else if (childElement.tagName === 'P') {
                        pdf.setFontSize(10);
                        currentY = addWrappedText(pdf, childElement.innerText, pdfMargin, currentY + 7, contentWidth, 10);
                    } else if (childElement.tagName === 'UL' && childElement.classList.contains('diagnosis-list')) {
                        // This is a list of symptoms (either for criteria or for a symptom category)
                        Array.from(childElement.children).forEach(mainSymptomLi => {
                            if (mainSymptomLi.tagName !== 'LI') return;

                            let mainLiText = "";
                            // Extract text content of the main symptom LI, stopping before any nested UL
                            for (let node of mainSymptomLi.childNodes) {
                                if (node.nodeType === Node.TEXT_NODE) {
                                    mainLiText += node.textContent;
                                } else if (node.tagName === 'UL') { // This is the UL for examples
                                    break; 
                                } else { // For other inline elements like <strong> in Criterion A
                                    mainLiText += node.textContent;
                                }
                            }
                            mainLiText = mainLiText.trim();

                            let prefix = mainSymptomLi.classList.contains('indicated') ? "[X] " : "[ ] ";
                            pdf.setFontSize(9);
                            pdf.setFont(undefined, 'normal'); 
                            currentY = addWrappedText(pdf, prefix + mainLiText, pdfMargin, currentY + 5, contentWidth, 9);

                            // Handle nested UL for examples (if any)
                            const examplesUl = mainSymptomLi.querySelector('ul'); 
                            if (examplesUl) {
                                Array.from(examplesUl.children).forEach(exampleLi => {
                                    if (exampleLi.tagName !== 'LI') return;

                                    pdf.setFontSize(9); 
                                    const exampleText = exampleLi.textContent.trim();
                                    const exampleIndent = pdfMargin + 15; 
                                    const exampleContentWidth = contentWidth - 15;

                                    if (exampleLi.style.listStyleType === 'none') { // Sub-header like "Examples reported:"
                                         pdf.setFont(undefined, 'italic');
                                         currentY = addWrappedText(pdf, exampleText, exampleIndent, currentY + 5, exampleContentWidth, 9);
                                         pdf.setFont(undefined, 'normal');
                                    } else { // Actual example item
                                        currentY = addWrappedText(pdf, "â€¢ " + exampleText, exampleIndent, currentY + 5, exampleContentWidth, 9);
                                    }
                                });
                            }
                        });
                    }
                    // Note: The `otherUls` loop (ul:not(.diagnosis-list)) was previously removed to fix a duplication glitch.
                    // If there are other types of ULs that need specific handling, they could be added here.
                });
                currentY += 10; // Add some space after processing all children of a .report-section
            }
            
            function addWrappedText(doc, text, x, y, maxWidth, fontSize, lineHeightFactor = 1.15) {
                const lines = doc.splitTextToSize(text, maxWidth);
                const lineHeight = fontSize * lineHeightFactor;
                lines.forEach((line, index) => {
                    if (y + (index * lineHeight) > doc.internal.pageSize.getHeight() - pdfMargin) {
                        doc.addPage();
                        y = pdfMargin - (index * lineHeight); 
                    }
                    doc.text(line, x, y + (index * lineHeight));
                });
                return y + (lines.length * lineHeight);
            }

            pdf.save('Young-DIVA-5-ADHD-Screener-Report.pdf');

            document.body.className = originalBodyClass;
            reportContentElement.style.cssText = originalReportStyle;
        }

        (function loadJsPdf() {
            if (!document.getElementById('jspdf-script-young')) { 
                const script = document.createElement('script');
                script.id = 'jspdf-script-young';
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.async = true;
                script.onload = () => {
                    console.log("jsPDF library loaded for Young DIVA.");
                };
                script.onerror = () => console.error("Failed to load jsPDF library for Young DIVA.");
                document.head.appendChild(script);
            }
        })();

        document.addEventListener('DOMContentLoaded', initializeScreener);

    </script>
</body>
</html>